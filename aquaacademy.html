<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Atlantis Academy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Styles & Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700" rel="stylesheet">
<style>
body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  color: #e0f7fa;
  display: flex;
  flex-direction: column;
  min-height:100vh;
  overflow: hidden;
  position: relative;
  background: linear-gradient(135deg, #003844 30%, #006064 100%);
}
.water {
  position:absolute;
  top:0;
  left:0;
  width:100%; 
  height:100%; 
  background: rgba(0,150,136,.3);
  animation: wave 6s infinite linear;
  z-index:0;
}
@keyframes wave {
  0% {transform: translateY(0);}
  50% {transform: translateY(10px);}
  100%{transform: translateY(0);}
}
header {
  background: rgba(0,56,68,.9);
  color:#ffcc80;
  padding:20px;
  text-align:center;
  position:relative;
  z-index:1;
}
nav {
  background: rgba(0,77,64,.95);
  color:#e0f7fa;
  padding:15px;
  display:flex;
  justify-content:space-around;
  box-shadow:0 2px 5px rgba(0,0,0,.3);
  z-index:1;
}
nav button {
  background:transparent;
  border:none;
  color:#e0f7fa;
  cursor:pointer;
  font-weight:500;
  transition:background .3s;
}
nav button:hover {
  background:rgba(255,204,128,.2);
}
.container {
  padding:20px;
  flex:1;
  display:none;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,.3);
  background:rgba(255,255,255,.95);
  color:#004d40;
  margin:20px;
  animation:fadeIn .5s;
  z-index:1;
}
.active {
  display:block;
}
input,select {
  padding:10px;
  margin:10px 0;
  border-radius:5px;
  border:1px solid #00796b;
  width:100%;
  box-sizing:border-box;
}
input:focus,select:focus {
  border-color:#ffcc80;
  outline:none;
}
button {
  padding:10px;
  margin:10px 0;
  border-radius:5px;
  border:none;
  background:#00796b;
  color:#fff;
  cursor:pointer;
  transition:background .3s, transform .2s;
  width:100%; 
}
button:hover {
  background:#ff8f00;
  transform:scale(1.03);
}
.error {
  color:#ff5722;
  margin:10px 0;
}
.spinner {
  display:none;
  margin:20px auto;
  text-align:center;
}
.dark-mode {
  background:#001f24;
  color:#e0f7fa;
}
footer {
  text-align:center;
  padding:10px;
  background:#004d40;
  color:#ffcc80;
  position:relative;
  bottom:0;
  width:100%; 
  z-index:1;
}
@keyframes fadeIn {
  from{opacity:0;}
  to{opacity:1;}
}

/* ==========================
    STYLING LEADERBOARD
========================== */
#allLeaderboards {
  max-height: 450px;
  overflow-y: auto;
  padding: 10px;
}
.leaderboard-subject {
  margin-bottom: 30px;
}
.leaderboard-subject h4,
.leaderboard-subject h3 {
  text-align: left;
  font-size: 1.2em;
  color: #ffcc80;
  font-weight: 600;
  border-bottom: 2px solid #ffcc80;
  padding-bottom: 5px;
  margin: 15px 0 5px;
}
.leaderboard-subject table {
  width:100%;
  border-collapse: collapse;
  margin-bottom:15px;
}
.leaderboard-subject table thead {
  background-color:#006064;
  color:#ffcc80;
}
.leaderboard-subject table th,
.leaderboard-subject table td {
  padding:10px 14px;
  border:1px solid #004d40;
  text-align:left;
}
.leaderboard-subject table tr:nth-child(odd) {
  background-color:#e0f2f1;
}
.leaderboard-subject table tr:nth-child(even) {
  background-color:#b2dfdb;
}
</style>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
<div class="water"></div>
<header><h1>Atlantis Academy</h1></header>

<!-- Login Screen -->
<div id="loginScreen" class="container active">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email (@atlantis.student.com)">
    <input type="password" id="loginPassword" placeholder="Password">
    <div id="loginError" class="error"></div>
    <button id="loginButton">Login</button>
    <div>Don't have an account? <a href="#" id="showRegisterLink">Register here</a></div>
</div>

<!-- Registration Screen -->
<div id="registerScreen" class="container">
    <h2>Register</h2>
    <input type="text" id="name" placeholder="Name">
    <input type="email" id="registerEmail" placeholder="Email (@atlantis.student.com)">
    <select id="educationLevel">
        <option value="">Select Education Level</option>
        <option value="SD">SD</option>
        <option value="SMP">SMP</option>
        <option value="SMA">SMA</option>
    </select>
    <input type="password" id="registerPassword" placeholder="Password">
    <input type="password" id="confirmPassword" placeholder="Confirm Password">
    <div id="registerError" class="error"></div>
    <button id="registerButton">Register</button>
    <div>Already have an account? <a href="#" id="showLoginLink">Back to Login</a></div>
</div>

<!-- Main Dashboard -->
<div id="dashboard" class="container">
    <nav>
        <button data-page="profilePage">Profile</button>
        <button data-page="materialsPage">Materials</button>
        <button data-page="exercisesPage">Exercises</button>
        <button data-page="leaderboardsPage">Leaderboards</button>
        <button id="logoutButton">Quit</button>
        <button id="toggleDarkMode">Toggle Dark Mode</button>
    </nav>
    <div id="profilePage" class="container active">
        <h3>Profile</h3>
        <div id="profileInfo"></div>
        <button id="changePasswordButton">Change Password</button>
    </div>
    <div id="materialsPage" class="container">
        <h3>Materials</h3>
        <ul>
            <li>Physics: <a href="https://url-to-your-physics.pdf" target="_blank">Download</a></li>
            <li>Chemistry: <a href="https://url-to-your-chemistry.pdf" target="_blank">Download</a></li>
            <li>Biology: <a href="https://url-to-your-biology.pdf" target="_blank">Download</a></li>
            <li>Indonesian: <a href="https://url-to-your-indonesian.pdf" target="_blank">Download</a></li>
            <li>English: <a href="https://url-to-your-english.pdf" target="_blank">Download</a></li>
            <li>Math: <a href="https://url-to-your-math.pdf" target="_blank">Download</a></li>
        </ul>
    </div>
    <div id="exercisesPage" class="container">
        <h3>Exercises</h3>
        <div id="subjectSelector">
            <select id="subjectSelect">
                <option value="">Pilih Mata Pelajaran</option>
                <option value="physics">Physics</option>
                <option value="chemistry">Chemistry</option>
                <option value="biology">Biology</option>
                <option value="indonesian">Indonesian</option>
                <option value="english">English</option>
                <option value="math">Math</option>
            </select>
            <button id="startExercise">Mulai</button>
        </div>
        <div id="questionDisplay"></div>
    </div>
    <div id="leaderboardsPage" class="container">
        <h3>Leaderboards</h3>
        <div id="allLeaderboards"></div>
    </div>
</div>

<div class="spinner" id="loadingSpinner">Loading...</div>

<!-- Scripts Logic -->
<script>
const firebaseConfig = {
    apiKey: "AIzaSyDR04p3qXOTTOp9OEwz-m-M46j5x2FKuKM",
    authDomain: "dungeon-223d9.firebaseapp.com",
    databaseURL: "https://dungeon-223d9-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "dungeon-223d9",
    storageBucket: "dungeon-223d9.firebasestorage.app",
    messagingSenderId: "144074668480",
    appId: "1:144074668480:web:a26bbacfa551112b15f025"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

// State
let currentUser = null;
let currentSubject = '';
let currentQuestionIndex = 0;
let userScore = 0;

const questions = {
    SD: {
        questions.SD.physics = [
            {q: "Benda yang dapat menghantarkan listrik disebut?", options: ["Isolator", "Konduktor", "Gas", "Cairan"], answer: "Konduktor"},
            {q: "Gaya gravitasi membuat benda bergerak ke arah?", options: ["Atas", "Bawah", "Kanan", "Kiri"], answer: "Bawah"},
            {q: "Energi dari matahari disebut energi?", options: ["Kinetik", "Panas", "Bunyi", "Listrik"], answer: "Panas"},
            {q: "Alat untuk mengukur suhu disebut?", options: ["Penggaris", "Termometer", "Neraca", "Mikroskop"], answer: "Termometer"},
            {q: "Benda yang dapat berubah bentuk jika ditekan disebut?", options: ["Benda Keras", "Benda Lentur", "Benda Padat", "Benda Cair"], answer: "Benda Lentur"},
            {q: "Saat bola dilempar ke atas, bola bergerak karena?", options: ["Energi Kinetik", "Energi Panas", "Energi Listrik", "Energi Bunyi"], answer: "Energi Kinetik"},
            {q: "Benda dapat bergerak karena dikenai?", options: ["Gaya", "Panas", "Bunyi", "Cahaya"], answer: "Gaya"},
            {q: "Saat lampu menyala, energi listrik berubah menjadi energi?", options: ["Panas dan Cahaya", "Kinetik", "Bunyi", "Kimia"], answer: "Panas dan Cahaya"},
            {q: "Saat sepeda dikayuh, energi yang digunakan adalah?", options: ["Energi Kimia", "Energi Bunyi", "Energi Kinetik", "Energi Listrik"], answer: "Energi Kinetik"},
            {q: "Saat benda dijatuhkan dari ketinggian, energi berubah dari?", options: ["Kinetik ke Potensial", "Potensial ke Kinetik", "Listrik ke Panas", "Kimia ke Bunyi"], answer: "Potensial ke Kinetik"},
            {q: "Saat mobil direm, energi kinetik berubah menjadi?", options: ["Energi Panas", "Energi Listrik", "Energi Kimia", "Energi Suara"], answer: "Energi Panas"},
            {q: "Saat lampu senter dinyalakan, energi kimia dari baterai berubah menjadi energi?", options: ["Cahaya dan Panas", "Kinetik dan Suara", "Bunyi dan Gerak", "Panas dan Kinetik"], answer: "Cahaya dan Panas"},
            {q: "Saat bola menggelinding, bola memiliki energi?", options: ["Kinetik", "Panas", "Bunyi", "Listrik"], answer: "Kinetik"},
            {q: "Energi yang digunakan untuk memindahkan benda disebut?", options: ["Energi Gerak", "Energi Panas", "Energi Cahaya", "Energi Kimia"], answer: "Energi Gerak"},
            {q: "Saat air mendidih, energi panas berubah menjadi energi?", options: ["Energi Bunyi", "Energi Gerak", "Energi Listrik", "Energi Kimia"], answer: "Energi Gerak"},
            {q: "Saat benda bergerak dari tinggi ke rendah, energi potensial berubah menjadi?", options: ["Energi Kinetik", "Energi Bunyi", "Energi Panas", "Energi Listrik"], answer: "Energi Kinetik"},
            {q: "Saat benda dilemparkan, energi awal yang digunakan disebut?", options: ["Energi Awal", "Energi Kinetik", "Energi Dorong", "Energi Gerak"], answer: "Energi Dorong"},
            {q: "Saat lampu dimatikan, energi listrik berhenti berubah menjadi?", options: ["Cahaya dan Panas", "Kinetik dan Bunyi", "Panas dan Suara", "Kimia dan Listrik"], answer: "Cahaya dan Panas"},
            {q: "Saat bola memantul, energi kinetik berubah sebagian menjadi energi?", options: ["Energi Bunyi dan Panas", "Energi Kimia", "Energi Listrik", "Energi Cahaya"], answer: "Energi Bunyi dan Panas"},
            {q: "Saat sebuah benda berada di tempat tinggi, energi yang dimilikinya disebut?", options: ["Energi Kinetik", "Energi Potensial", "Energi Bunyi", "Energi Panas"], answer: "Energi Potensial"}
          ],
        questions.SD.chemistry = [
            {q: "Air termasuk contoh zat berwujud?", options: ["Padat", "Cair", "Gas", "Api"], answer: "Cair"},
            {q: "Contoh perubahan wujud dari cair ke gas disebut?", options: ["Mengembun", "Menguap", "Menyublim", "Meleleh"], answer: "Menguap"},
            {q: "Bahan yang dapat menghantarkan panas disebut?", options: ["Konduktor", "Isolator", "Plastik", "Karet"], answer: "Konduktor"},
            {q: "Gas yang digunakan tumbuhan untuk fotosintesis?", options: ["Oksigen", "Hidrogen", "Karbondioksida", "Nitrogen"], answer: "Karbondioksida"},
            {q: "Contoh zat asam dalam rumah tangga?", options: ["Gula", "Garam", "Cuka", "Sabun"], answer: "Cuka"},
            {q: "Contoh benda padat adalah?", options: ["Air", "Batu", "Minyak", "Uap"], answer: "Batu"},
            {q: "Saat es dipanaskan, berubah menjadi?", options: ["Air", "Gas", "Padat", "Asap"], answer: "Air"},
            {q: "Saat air dipanaskan terus-menerus berubah menjadi?", options: ["Gas", "Padat", "Cair", "Keras"], answer: "Gas"},
            {q: "Contoh zat cair?", options: ["Air", "Besi", "Kaca", "Batu"], answer: "Air"},
            {q: "Benda yang dapat menyala disebut?", options: ["Konduktor", "Isolator", "Bahan Bakar", "Plastik"], answer: "Bahan Bakar"},
            {q: "Contoh bahan bakar dari fosil?", options: ["Bensin", "Garam", "Pasir", "Gula"], answer: "Bensin"},
            {q: "Saat lilin terbakar, terjadi perubahan dari?", options: ["Padat ke Gas", "Gas ke Cair", "Cair ke Padat", "Gas ke Padat"], answer: "Padat ke Gas"},
            {q: "Contoh perubahan kimia?", options: ["Besi Berkarat", "Air Membeku", "Es Mencair", "Kertas Digunting"], answer: "Besi Berkarat"},
            {q: "Contoh perubahan fisika?", options: ["Es Mencair", "Besi Berkarat", "Kue Matang", "Buah Membusuk"], answer: "Es Mencair"},
            {q: "Saat air direbus, perubahan yang terjadi?", options: ["Cair ke Gas", "Gas ke Padat", "Padat ke Gas", "Gas ke Cair"], answer: "Cair ke Gas"},
            {q: "Saat kapur barus diletakkan, lamaâ€‘lama berubah dari padat menjadi?", options: ["Gas", "Cair", "Beku", "Keras"], answer: "Gas"},
            {q: "Contoh zat asam alami?", options: ["Jeruk", "Nasi", "Gula", "Garam"], answer: "Jeruk"},
            {q: "Saat kayu dibakar, energi kimia berubah menjadi?", options: ["Energi Panas dan Cahaya", "Energi Gerak", "Energi Listrik", "Energi Suara"], answer: "Energi Panas dan Cahaya"},
            {q: "Saat membuat es batu, air berubah dari?", options: ["Cair ke Padat", "Padat ke Gas", "Gas ke Cair", "Cair ke Gas"], answer: "Cair ke Padat"},
            {q: "Saat membuat teh, air panas digunakan untuk?", options: ["Melarutkan teh dan gula", "Mengubah teh menjadi padat", "Membekukan air", "Menguapkan air"], answer: "Melarutkan teh dan gula"}
          ],
    },
    SMP: {
        questions.SMP.physics = [
          {q: "Benda yang dapat menghantarkan listrik disebut?", options: ["Isolator", "Konduktor", "Gas", "Cairan"], answer: "Konduktor"},
          {q: "Gaya gravitasi membuat benda bergerak ke arah?", options: ["Atas", "Bawah", "Kanan", "Kiri"], answer: "Bawah"},
          {q: "Energi dari matahari disebut energi?", options: ["Kinetik", "Panas", "Bunyi", "Listrik"], answer: "Panas"},
          {q: "Alat untuk mengukur suhu disebut?", options: ["Penggaris", "Termometer", "Neraca", "Mikroskop"], answer: "Termometer"},
          {q: "Benda yang dapat berubah bentuk jika ditekan disebut?", options: ["Benda Keras", "Benda Lentur", "Benda Padat", "Benda Cair"], answer: "Benda Lentur"},
          {q: "Besaran yang dapat diukur disebut?", options: ["Besaran Pokok", "Besaran Turunan", "Besaran Vektor", "Besaran Skalar"], answer: "Besaran Pokok"},
          {q: "Contoh besaran pokok adalah?", options: ["Massa", "Volume", "Kecepatan", "Gaya"], answer: "Massa"},
          {q: "Besaran turunan terdiri dari?", options: ["Panjang", "Suhu", "Kecepatan", "Massa"], answer: "Kecepatan"},
          {q: "Satuan SI untuk panjang adalah?", options: ["Gram", "Meter", "Detik", "Kelvin"], answer: "Meter"},
          {q: "Besaran yang memiliki nilai dan arah disebut?", options: ["Besaran Skalar", "Besaran Vektor", "Besaran Pokok", "Besaran Ukuran"], answer: "Besaran Vektor"},
          {q: "Gaya yang dapat mengubah bentuk benda disebut?", options: ["Gaya Otot", "Gaya Pegas", "Gaya Kontak", "Gaya Gesek"], answer: "Gaya Kontak"},
          {q: "Contoh energi kinetik terdapat pada?", options: ["Bola Diam", "Bola Berputar", "Meja", "Buku di Rak"], answer: "Bola Berputar"},
          {q: "Energi yang dimiliki benda karena kedudukannya disebut?", options: ["Energi Kinetik", "Energi Potensial", "Energi Listrik", "Energi Kimia"], answer: "Energi Potensial"},
          {q: "Besaran yang dapat berubah seiring waktu disebut?", options: ["Besaran Skalar", "Besaran Tetap", "Besaran Vektor", "Besaran Kontinu"], answer: "Besaran Kontinu"},
          {q: "Hukum Newton I disebut juga dengan hukum?", options: ["Kelembaman", "Akselerasi", "Gravitasi", "Kekekalan Energi"], answer: "Kelembaman"},
          {q: "Gaya total yang bekerja pada benda disebut?", options: ["Resultan Gaya", "Gaya Kontak", "Gaya Normal", "Gaya Gesek"], answer: "Resultan Gaya"},
          {q: "Satuan SI untuk gaya adalah?", options: ["Newton", "Joule", "Pascal", "Kelvin"], answer: "Newton"},
          {q: "Besaran yang tidak mempunyai arah disebut?", options: ["Besaran Vektor", "Besaran Skalar", "Besaran Kontinu", "Besaran Fisika"], answer: "Besaran Skalar"},
          {q: "Saat gaya total nol, maka benda bergerak dengan?", options: ["Percepatan tetap", "Kecepatan tetap", "Berlokasi", "Mengalami percepatan"], answer: "Kecepatan tetap"},
          {q: "Saat benda bergerak dipercepat, maka gaya totalnya?", options: ["Nol", "Searah dengan percepatan", "Berlawanan dengan percepatan", "Tidak berubah"], answer: "Searah dengan percepatan"},
          {q: "Besaran panjang dapat diukur dengan alat?", options: ["Neraca", "Jangka sorong", "Stopwatch", "Termometer"], answer: "Jangka sorong"},
          {q: "Besaran waktu dapat diukur dengan alat?", options: ["Neraca", "Stopwatch", "Amperemeter", "Voltmeter"], answer: "Stopwatch"},
          {q: "Besaran suhu dapat diukur dengan alat?", options: ["Stopwatch", "Neraca", "Amperemeter", "Termometer"], answer: "Termometer"},
          {q: "Contoh gaya tak sentuh adalah?", options: ["Gaya Gesek", "Gaya Pegas", "Gaya Gravitasi", "Gaya Otot"], answer: "Gaya Gravitasi"},
          {q: "Saat resultan gaya = 0, benda berada dalam keadaan?", options: ["Seimbang", "Berakselerasi", "Jatuh", "Menggelinding"], answer: "Seimbang"}
        ];
    },
    SMA: {
        physics: [{q: "Contoh soal Fisika SMA?", options: ["A", "B", "C", "D"], answer: "B"}]
    }
};

function showContainer(containerId) {
    document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
    document.getElementById(containerId).classList.add('active');
}
function showPage(pageId) {
    document.querySelectorAll('#dashboard .container').forEach(el => el.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}
function showLoading() { document.getElementById('loadingSpinner').style.display = 'block'; }
function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }

// =================== EXERCISES LOGIC ===================
const subjectSelectEl = document.getElementById('subjectSelect');
const startExerciseButton = document.getElementById('startExercise');
const questionDisplay = document.getElementById('questionDisplay');

startExerciseButton.addEventListener('click', async() => {
    currentSubject = subjectSelectEl.value;
    if (!currentSubject) {
        alert('Pilih mata pelajaran dulu!');
        return;
    }
    if (!questions[currentUser.education_level][currentSubject]) {
        alert('Maaf, belum ada soal untuk mata pelajaran ini!');
        return;
    }
    if (confirm(`Kamu siap menjawab soal ${currentSubject}?`)) {
        currentQuestionIndex = 0;
        userScore = 0;
        showNextQuestion();
    }
});

function showNextQuestion() {
    const subjectQuestions = questions[currentUser.education_level][currentSubject];
    if (currentQuestionIndex >= Math.min(10, subjectQuestions.length)) {
        endExercise();
        return;
    }
    const qObj = subjectQuestions[currentQuestionIndex];
    questionDisplay.innerHTML = `
        <p>${currentQuestionIndex + 1}. ${qObj.q}</p>
        ${qObj.options.map(opt =>
            `<button class="optionBtn" data-answer="${qObj.answer}">${opt}</button>`).join('')}
    `;
    document.querySelectorAll('.optionBtn').forEach(button => {
        button.addEventListener('click', e => {
            const correctAnswer = e.target.getAttribute('data-answer');
            const selected = e.target.textContent.trim();
            if (selected === correctAnswer) {
                alert("Correct!");
                userScore += 1;
            } else {
                alert("Wrong Answer.");
            }
            currentQuestionIndex++;
            showNextQuestion();
        });
    });
}

async function endExercise() {
    alert(`Kamu selesai! Skor kamu: ${userScore}/${Math.min(10, questions[currentUser.education_level][currentSubject].length)}`);
    await db.ref(`users/${currentUser.uid}/points/${currentSubject}`)
        .transaction(val => (val || 0) + userScore);
    await db.ref(`users/${currentUser.uid}/total_score`)
        .transaction(val => (val || 0) + userScore);
    alert("Skor kamu berhasil disimpan!");
    db.ref('users/' + currentUser.uid).once('value').then(snapshot => {
        currentUser = snapshot.val();
        currentUser.uid = auth.currentUser.uid;
        loadProfile();
    });
    questionDisplay.innerHTML = '';
}

// =================== AUTH LOGIC ===================
document.getElementById('loginButton').addEventListener('click', async() => {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!email.endsWith('@atlantis.student.com')) {
        document.getElementById('loginError').innerText = "Email must be atlantis.student.com.";
        return;
    }
    showLoading();
    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch(error) {
        document.getElementById('loginError').innerText = error.message;
    } finally {
        hideLoading();
    }
});
document.getElementById('registerButton').addEventListener('click', async() => {
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const educationLevel = document.getElementById('educationLevel').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    const confirmPassword = document.getElementById('confirmPassword').value.trim();
    if (!name || !email.endsWith('@atlantis.student.com') || !educationLevel || password.length < 6 || password !== confirmPassword) {
        document.getElementById('registerError').innerText = "Check all fields and match passwords.";
        return;
    }
    showLoading();
    try {
        const userCred = await auth.createUserWithEmailAndPassword(email, password);
        await userCred.user.sendEmailVerification();
        await db.ref('users/' + userCred.user.uid).set({
            name,
            email,
            education_level: educationLevel,
            points: { physics:0, chemistry:0, biology:0, indonesian:0, english:0, math:0 },
            total_score: 0
        });
        alert("Registration successful! Check your email for verification.");
        showContainer('loginScreen');
    } catch(error) {
        document.getElementById('registerError').innerText = error.message;
    } finally {
        hideLoading();
    }
});

// =================== AUTH STATE CHANGED ===================
auth.onAuthStateChanged(user => {
    if (user) {
        showLoading();
        db.ref('users/' + user.uid).once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    currentUser = snapshot.val();
                    currentUser.uid = user.uid;

                    loadProfile();
                    loadLeaderboards();
                    showContainer('dashboard');
                } else {
                    alert("Data user tidak ditemukan. Mohon daftar ulang.");
                    auth.signOut();
                }
            })
            .finally(hideLoading);
    } else {
        showContainer('loginScreen');
    }
});

// =================== UTILITY LOADS ===================
function loadProfile() {
    document.getElementById('profileInfo').innerHTML = `
        <p>Name: ${currentUser.name}</p>
        <p>Email: ${currentUser.email}</p>
        <p>Education Level: ${currentUser.education_level}</p>
        <p>Points:
            Physics: ${currentUser.points.physics || 0},
            Chemistry: ${currentUser.points.chemistry || 0},
            Biology: ${currentUser.points.biology || 0},
            Indonesian: ${currentUser.points.indonesian || 0},
            English: ${currentUser.points.english || 0},
            Math: ${currentUser.points.math || 0}
        </p>
        <p>Total Score: ${currentUser.total_score}</p>`;
}
function loadLeaderboards() {
    const leaderboardDiv = document.getElementById('allLeaderboards');
    leaderboardDiv.innerHTML = '';
    db.ref('users').once('value').then(snapshot => {
        const data = snapshot.val();
        const subjects = ["physics","chemistry","biology","indonesian","english","math"];
        subjects.forEach(sub => {
            let scores = [];
            for (let uid in data) {
                scores.push({name: data[uid].name, score: data[uid].points[sub] || 0});
            }
            scores.sort((a, b) => b.score - a.score);
            
            // Buat Table
            let tableRows = scores.slice(0, 10).map((user, index) =>
                `<tr><td>${index + 1}</td><td>${user.name}</td><td>${user.score}</td></tr>`).join('');

            leaderboardDiv.innerHTML += `
                <div class="leaderboard-subject">
                    <h4>${sub.toUpperCase()} Leaderboard (Top 10)</h4>
                    <table>
                        <thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>`;
        });
        // Overall Leaderboard
        let overall = [];
        for (let uid in data) {
            overall.push({name: data[uid].name, score: data[uid].total_score || 0});
        }
        overall.sort((a, b) => b.score - a.score);
        let overallRows = overall.slice(0, 10).map((user, index) =>
            `<tr><td>${index + 1}</td><td>${user.name}</td><td>${user.score}</td></tr>`).join('');

        leaderboardDiv.innerHTML += `
            <div class="leaderboard-subject">
                <h3>Overall Leaderboard (Top 10)</h3>
                <table>
                    <thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead>
                    <tbody>${overallRows}</tbody>
                </table>
            </div>`;
    });
}

// =================== BUTTONS LOGIC ===================
document.querySelectorAll('nav button[data-page]').forEach(button => {
    button.addEventListener('click', e => {
        showPage(button.getAttribute('data-page'));
    });
});
document.getElementById('changePasswordButton').addEventListener('click', async() => {
    const newPass = prompt("Enter new password:");
    if(newPass) {
        try {
            await auth.currentUser.updatePassword(newPass);
            alert("Password updated!");
        } catch(error) {
            alert(error.message);
        }
    }
});
document.getElementById('logoutButton').addEventListener('click', async() => {
    await auth.signOut();
});
document.getElementById('toggleDarkMode').addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
});
document.getElementById('showRegisterLink').addEventListener('click', e => {
    e.preventDefault();
    showContainer('registerScreen');
});
document.getElementById('showLoginLink').addEventListener('click', e => {
    e.preventDefault();
    showContainer('loginScreen');
});
</script>
<footer><p>&copy; 2023 Atlantis Academy. All rights reserved.</p></footer>
</body>
</html>
