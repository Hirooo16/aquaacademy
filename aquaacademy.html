<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlantis Academy</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #e0f7fa;
            color: #00796b;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }
        .container {
            width: 90%;
            max-width: 600px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: none;
        }
        .active {
            display: block;
        }
        h2 {
            text-align: center;
            color: #00796b;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #00796b;
            border-radius: 5px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #004d40;
        }
        .link {
            text-align: center;
            margin-top: 10px;
        }
        .link a {
            color: #00796b;
            text-decoration: none;
        }
        .link a:hover {
            text-decoration: underline;
        }
        .leaderboard, .exercise {
            margin-top: 20px;
            padding: 10px;
            background: #f1f1f1;
            border-radius: 5px;
        }
        .exercise button {
            margin: 5px 0;
        }
        .error {
            color: red;
            font-size: 0.9em;
            margin-top: -10px;
            margin-bottom: 10px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-analytics.js"></script>
</head>
<body>

    <div id="login" class="container active">
        <h2>Login</h2>
        <input type="email" id="loginEmail" placeholder="Email (@atlantis.student.com)" required>
        <div class="error" id="loginError"></div>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button onclick="login()">Login</button>
        <div class="link">Don't have an account? <a href="#" onclick="showRegister()">Register here</a></div>
    </div>

    <div id="register" class="container">
        <h2>Register</h2>
        <input type="text" id="name" placeholder="Name" required>
        <div class="error" id="registerNameError"></div>
        <input type="email" id="registerEmail" placeholder="Email (@atlantis.student.com)" required>
        <div class="error" id="registerEmailError"></div>
        <select id="educationLevel" required>
            <option value="">Select Education Level</option>
            <option value="SD">SD</option>
            <option value="SMP">SMP</option>
            <option value="SMA">SMA</option>
        </select>
        <div class="error" id="registerLevelError"></div>
        <input type="password" id="registerPassword" placeholder="Password" required>
        <div class="error" id="registerPasswordError"></div>
        <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
        <div class="error" id="confirmPasswordError"></div>
        <button onclick="register()">Register</button>
        <div class="link">Already have an account? <a href="#" onclick="showLogin()">Back to Login</a></div>
    </div>

    <div id="dashboard" class="container">
        <h2>Main Dashboard</h2>
        <div id="userInfo"></div>
        <div class="exercise" id="exerciseSection"></div>
        <button onclick="changePassword()">Change Password</button>
        <button onclick="logout()">Logout</button>
        <div class="leaderboard" id="leaderboard"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDR04p3qXOTTOp9OEwz-m-M46j5x2FKuKM",
            authDomain: "dungeon-223d9.firebaseapp.com",
            databaseURL: "https://dungeon-223d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "dungeon-223d9",
            storageBucket: "dungeon-223d9.firebasestorage.app",
            messagingSenderId: "144074668480",
            appId: "1:144074668480:web:a26bbacfa551112b15f025",
            measurementId: "G-H4TYZ2Y5RQ"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.getAnalytics(app);
        const auth = firebase.auth();
        const database = firebase.database();

        // Show login screen
        function showLogin() {
            clearErrors();
            document.getElementById('login').classList.add('active');
            document.getElementById('register').classList.remove('active');
            document.getElementById('dashboard').classList.remove('active');
        }

        // Show registration screen
        function showRegister() {
            clearErrors();
            document.getElementById('register').classList.add('active');
            document.getElementById('login').classList.remove('active');
            document.getElementById('dashboard').classList.remove('active');
        }

        // Clear error messages
        function clearErrors() {
            document.querySelectorAll('.error').forEach(el => el.innerHTML = '');
        }

        // Show dashboard
        function showDashboard(user) {
            document.getElementById('userInfo').innerHTML = `
                <p>Name: ${user.name}</p>
                <p>Email: ${user.email}</p>
                <p>Education Level: ${user.education_level}</p>
                <p>Points: ${user.total_score}</p>
            `;
            loadExercises(user.education_level);
            loadLeaderboard();
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('login').classList.remove('active');
            document.getElementById('register').classList.remove('active');
        }

        // Load exercises based on education level
        function loadExercises(educationLevel) {
            const exercises = {
                SD: [
                    { question: "What is 2 + 2?", options: ["3", "4", "5"], answer: "4" },
                    { question: "What is the capital of Indonesia?", options: ["Jakarta", "Bali", "Bandung"], answer: "Jakarta" }
                ],
                SMP: [
                    { question: "What is Newtonâ€™s second law?", options: ["F=ma", "E=mc^2", "a^2+b^2=c^2"], answer: "F=ma" },
                    { question: "What is the chemical symbol for water?", options: ["H2O", "O2", "CO2"], answer: "H2O" }
                ],
                SMA: [
                    { question: "What is the powerhouse of the cell?", options: ["Mitochondria", "Nucleus", "Ribosome"], answer: "Mitochondria" },
                    { question: "What is the antonym of 'besar'?", options: ["Kecil", "Sedang", "Besar"], answer: "Kecil" }
                ]
            };

            const selectedExercises = exercises[educationLevel] || [];
            let exerciseHTML = '<h3>Exercises</h3>';
            selectedExercises.forEach((exercise, index) => {
                exerciseHTML += `
                    <div>
                        <p>${index + 1}. ${exercise.question}</p>
                        ${exercise.options.map(option => `
                            <button onclick="submitAnswer('${exercise.answer}', '${option}')">${option}</button>
                        `).join('')}
                    </div>
                `;
            });
            document.getElementById('exerciseSection').innerHTML = exerciseHTML;
        }

        // Submit answer and update points
        function submitAnswer(correctAnswer, selectedAnswer) {
            if (correctAnswer === selectedAnswer) {
                alert("Correct answer!");
                const userId = auth.currentUser .uid;
                const subject = "math"; // Example subject, you can modify this based on the exercise
                database.ref('users/' + userId + '/points/' + subject).transaction(points => (points || 0) + 1);
                database.ref('users/' + userId + '/total_score').transaction(total => (total || 0) + 1);
            } else {
                alert("Wrong answer!");
            }
        }

        // Load leaderboard
        function loadLeaderboard() {
            database.ref('leaderboards').once('value').then(snapshot => {
                let leaderboardHTML = '<h3>Leaderboard</h3><ul>';
                snapshot.forEach(childSnapshot => {
                    const subject = childSnapshot.key;
                    const scores = childSnapshot.val();
                    leaderboardHTML += `<li>${subject}: ${JSON.stringify(scores)}</li>`;
                });
                leaderboardHTML += '</ul>';
                document.getElementById('leaderboard').innerHTML = leaderboardHTML;
            });
        }

        // Login function
        function login() {
            clearErrors();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email.endsWith('@atlantis.student.com')) {
                document.getElementById('loginError').innerHTML = "Email must end with @atlantis.student.com.";
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const userId = userCredential.user.uid;
                    return database.ref('users/' + userId).once('value');
                })
                .then(snapshot => {
                    const user = snapshot.val();
                    showDashboard(user);
                })
                .catch(error => {
                    document.getElementById('loginError').innerHTML = error.message;
                });
        }

        // Register function
        function register() {
            clearErrors();
            const name = document.getElementById('name').value;
            const email = document.getElementById('registerEmail').value;
            const educationLevel = document.getElementById('educationLevel').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!name) {
                document.getElementById('registerNameError').innerHTML = "Name is required.";
                return;
            }
            if (!email.endsWith('@atlantis.student.com')) {
                document.getElementById('registerEmailError').innerHTML = "Email must end with @atlantis.student.com.";
                return;
            }
            if (!educationLevel) {
                document.getElementById('registerLevelError').innerHTML = "Education level is required.";
                return;
            }
            if (password.length < 6) {
                document.getElementById('registerPasswordError').innerHTML = "Password must be at least 6 characters.";
                return;
            }
            if (password !== confirmPassword) {
                document.getElementById('confirmPasswordError').innerHTML = "Passwords do not match!";
                return;
            }

            auth.createUser WithEmailAndPassword(email, password)
                .then(userCredential => {
                    const userId = userCredential.user.uid;
                    return database.ref('users/' + userId).set({
                        name: name,
                        email: email,
                        education_level: educationLevel,
                        points: {
                            physics: 0,
                            chemistry: 0,
                            biology: 0,
                            indonesian: 0,
                            english: 0,
                            math: 0
                        },
                        total_score: 0
                    });
                })
                .then(() => {
                    alert("Registration successful!");
                    showLogin();
                })
                .catch(error => {
                    document.getElementById('registerEmailError').innerHTML = error.message;
                });
        }

        // Change password function
        function changePassword() {
            const newPassword = prompt("Enter new password:");
            const user = auth.currentUser ;

            user.updatePassword(newPassword).then(() => {
                alert("Password changed successfully!");
            }).catch(error => {
                alert(error.message);
            });
        }

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                showLogin();
            });
        }

        // Monitor authentication state
        auth.onAuthStateChanged(user => {
            if (user) {
                const userId = user.uid;
                database.ref('users/' + userId).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    showDashboard(userData);
                });
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
